/**
 * Location Manager - Unified CRUD Interface
 * Supports: List, Create, Edit, Delete
 */

"use client";
import {
  uploadLocationImage,
  uploadMultipleLocationImages,
} from "@/lib/storage";
import { createSupabaseBrowserClient } from "@/lib/supabaseClient";
import React, { useEffect, useState } from "react";
import styles from "./Addlocation.module.css";

type FlightPackage = {
  id?: number;
  key: string;
  title: string;
  description: string;
  info: string;
  price: string;
  discount: string;
  features: string[]; // Array of feature strings (checkmarks)
};

type LocationSection = {
  id: string;
  heading: string;
  body: string;
  images: File[];
  existingImages?: string[]; // For edit mode
};

type LocationDraft = {
  // Basic Info
  locationId: string;
  altitude?: number;

  // Images
  heroImage: File | null;
  heroImageUrl: string;
  cardImage: File | null;
  cardImageUrl: string;

  // Gallery (location_gallery)
  galleryImages: File[]; // New images to upload
  existingGalleryUrls: string[]; // URLs from DB (for edit mode)

  // Hero Section (location_translations)
  slogan: string; // hero_headline + card_name
  mainText: string; // hero_tagline
  overlayTitle: string; // hero_overlay_title (NEW!)
  overlayDesc: string; // hero_overlay_desc (NEW!)

  // Card Section (location_translations)
  description: string; // card_tagline
  region: string; // card_region (NEW!)

  // Info Section (location_translations)
  infoCardTitle: string; // info_title
  infoCardText: string; // info_intro

  // Highlights (location_highlights + translations)
  highlights: Array<{
    id?: number; // For edit mode
    title: string; // e.g. "·É°·Éò·Éõ·Éê·É¶·Éö·Éî" (was "label" - must match DB column)
    value: string; // e.g. "2196 ·Éõ"
    icon?: string; // e.g. "üìç" (optional)
  }>;

  // Tips (location_tips + translations)
  tips: Array<{
    id?: number; // For edit mode
    text: string; // e.g. "·Éì·Éò·Éö·Éò·É° ·É°·Éê·Éê·Éó·Éî·Éë·Éò ·É°·Éê·É£·Éô·Éî·Éó·Éî·É°·Éù·Éê ·É§·É†·Éî·Éú·Éò·É°·Éó·Éï·Éò·É°"
  }>;

  // Tags (deprecated - can remove)
  tags: string[];

  // Flight Packages (location_fly_types + translations)
  flights: FlightPackage[];

  // Sections (location_sections + translations)
  sections: LocationSection[];
};

interface LocationRow {
  id: string;
  href: string;
  card_status: string;
  card_altitude: number;
  is_published: boolean;
  created_at: string;
  location_translations: Array<{
    language_code: string;
    card_name: string;
    hero_headline: string;
  }>;
}

type ViewMode = "list" | "create" | "edit";

interface LocationManagerProps {
  initialMode?: ViewMode;
  editLocationId?: string;
}

export default function LocationManager({
  initialMode = "list",
  editLocationId,
}: LocationManagerProps) {
  const [viewMode, setViewMode] = useState<ViewMode>(initialMode);
  const [currentEditId, setCurrentEditId] = useState<string | undefined>(
    editLocationId
  );

  // List View State
  const [locations, setLocations] = useState<LocationRow[]>([]);
  const [listLoading, setListLoading] = useState(false);
  const [listError, setListError] = useState("");

  // Form State
  const [draft, setDraft] = useState<LocationDraft>(getEmptyDraft());
  const [tagInput, setTagInput] = useState("");
  const [formSaving, setFormSaving] = useState(false);
  const [formStatus, setFormStatus] = useState("");

  // Load locations when in list mode
  useEffect(() => {
    if (viewMode === "list") {
      loadLocations();
    }
  }, [viewMode]);

  // Load location data when editing
  useEffect(() => {
    if (viewMode === "edit" && currentEditId) {
      loadLocationForEdit(currentEditId);
    }
  }, [viewMode, currentEditId]);

  function getEmptyDraft(): LocationDraft {
    return {
      // Basic
      locationId: "",
      altitude: 0,

      // Images
      heroImage: null,
      heroImageUrl: "",
      cardImage: null,
      cardImageUrl: "",

      // Gallery
      galleryImages: [],
      existingGalleryUrls: [],

      // Hero
      slogan: "",
      mainText: "",
      overlayTitle: "",
      overlayDesc: "",

      // Card
      description: "",
      region: "",

      // Info
      infoCardTitle: "",
      infoCardText: "",

      // Highlights (pre-populated with common examples)
      highlights: [
        { title: "·É°·Éò·Éõ·Éê·É¶·Éö·Éî", value: "", icon: "üìç" },
        { title: "·É§·É†·Éî·Éú·Éò·É° ·É°·Éî·Éñ·Éù·Éú·Éò", value: "", icon: "üìÖ" },
        { title: "·Éõ·Éê·Éú·É´·Éò·Éö·Éò ·Éó·Éë·Éò·Éö·Éò·É°·Éò·Éì·Éê·Éú", value: "", icon: "üöó" },
        { title: "·É§·É†·Éî·Éú·Éò·É° ·ÉÆ·Éê·Éú·Éí·É†·É´·Éö·Éò·Éï·Éù·Éë·Éê", value: "", icon: "‚è±Ô∏è" },
      ],

      // Tips
      tips: [],

      // Legacy
      tags: [],

      // Flight packages
      flights: [
        {
          key: "acro",
          title: "·Éê·Éô·É†·Éù·Éë·Éê·É¢·É£·Éö·Éò ·É§·É†·Éî·Éú·Éê",
          description: "",
          info: "",
          price: "",
          discount: "",
          features: [],
        },
        {
          key: "long",
          title: "·ÉÆ·Éê·Éú·Éí·É†·É´·Éö·Éò·Éï·Éò ·É§·É†·Éî·Éú·Éê",
          description: "",
          info: "",
          price: "",
          discount: "",
          features: [],
        },
        {
          key: "standard",
          title: "·É°·É¢·Éê·Éú·Éì·Éê·É†·É¢·É£·Éö·Éò ·É§·É†·Éî·Éú·Éê",
          description: "",
          info: "",
          price: "",
          discount: "",
          features: [],
        },
      ],

      // Sections
      sections: [
        { id: "sec-1", heading: "", body: "", images: [] },
        { id: "sec-2", heading: "", body: "", images: [] },
        { id: "sec-3", heading: "", body: "", images: [] },
      ],
    };
  }

  // ============ LIST FUNCTIONS ============

  const loadLocations = async () => {
    setListLoading(true);
    setListError("");

    try {
      const supabase = createSupabaseBrowserClient();

      const { data, error } = await supabase
        .from("locations")
        .select(
          `
					id,
					href,
					card_status,
					card_altitude,
					is_published,
					created_at,
					location_translations!inner (
						language_code,
						card_name,
						hero_headline
					)
				`
        )
        .eq("location_translations.language_code", "ka")
        .order("created_at", { ascending: false });

      if (error) throw error;

      setLocations(data || []);
    } catch (err: any) {
      console.error("Load locations error:", err);
      setListError(err.message);
    } finally {
      setListLoading(false);
    }
  };

  const handleDelete = async (locationId: string) => {
    if (
      !confirm(
        `·Éì·Éê·É†·É¨·Éõ·É£·Éú·Éî·Éë·É£·Éö·Éò ·ÉÆ·Éê·É† ·É†·Éù·Éõ ·Éí·É°·É£·É†·É° "${locationId}" ·É¨·Éê·É®·Éö·Éê? (cascade delete)`
      )
    ) {
      return;
    }

    try {
      const supabase = createSupabaseBrowserClient();

      const { error } = await supabase
        .from("locations")
        .delete()
        .eq("id", locationId);

      if (error) throw error;

      alert("‚úÖ ·Éö·Éù·Éô·Éê·É™·Éò·Éê ·É¨·Éê·É†·Éõ·Éê·É¢·Éî·Éë·Éò·Éó ·É¨·Éê·Éò·É®·Éê·Éö·Éê!");
      loadLocations();
    } catch (err: any) {
      console.error("Delete error:", err);
      alert(`‚ùå ·É¨·Éê·É®·Éö·Éò·É° ·É®·Éî·É™·Éì·Éù·Éõ·Éê: ${err.message}`);
    }
  };

  const handleTogglePublish = async (
    locationId: string,
    currentStatus: boolean
  ) => {
    try {
      const supabase = createSupabaseBrowserClient();

      const { error } = await supabase
        .from("locations")
        .update({ is_published: !currentStatus })
        .eq("id", locationId);

      if (error) throw error;

      alert(`‚úÖ ·É°·É¢·Éê·É¢·É£·É°·Éò ·É®·Éî·Éò·É™·Éï·Éê·Éö·Éê!`);
      loadLocations();
    } catch (err: any) {
      console.error("Toggle error:", err);
      alert(`‚ùå ·É®·Éî·É™·Éì·Éù·Éõ·Éê: ${err.message}`);
    }
  };

  const handleEdit = (locationId: string) => {
    setCurrentEditId(locationId);
    setViewMode("edit");
  };

  const handleCreateNew = () => {
    setDraft(getEmptyDraft());
    setCurrentEditId(undefined);
    setViewMode("create");
  };

  const backToList = () => {
    setViewMode("list");
    setDraft(getEmptyDraft());
    setCurrentEditId(undefined);
    setFormStatus("");
  };

  // ============ EDIT LOAD FUNCTION ============

  const loadLocationForEdit = async (locationId: string) => {
    setFormSaving(true);
    setFormStatus("üì• ·Éö·Éù·Éô·Éê·É™·Éò·Éò·É° ·É©·Éê·É¢·Éï·Éò·É†·Éó·Éï·Éê...");

    try {
      const supabase = createSupabaseBrowserClient();

      // Load main location
      const { data: loc, error: locError } = await supabase
        .from("locations")
        .select(
          `
					id,
					hero_bg,
					hero_thumb,
					card_thumbnail,
					card_altitude,
					gallery_urls,
					location_translations!inner (
						language_code,
						hero_headline,
						hero_tagline,
						hero_overlay_title,
						hero_overlay_desc,
						card_name,
						card_region,
						card_tagline,
						info_title,
						info_intro
					)
				`
        )
        .eq("id", locationId)
        .eq("location_translations.language_code", "ka")
        .single();

      if (locError) throw locError;

      const translation = loc.location_translations[0];

      // Load sections
      const { data: sections } = await supabase
        .from("location_sections")
        .select(
          `
					id,
					order_index,
					location_section_translations!inner (
						language_code,
						title,
						content
					)
				`
        )
        .eq("location_id", locationId)
        .eq("location_section_translations.language_code", "ka")
        .order("order_index");

      // Load flights
      const { data: flights } = await supabase
        .from("location_fly_types")
        .select(
          `
					id,
					fly_type_id,
					price,
					location_fly_type_translations!inner (
						language_code,
						name,
						description,
						features
					)
				`
        )
        .eq("location_id", locationId)
        .eq("location_fly_type_translations.language_code", "ka")
        .order("order_index");

      // Load highlights
      const { data: highlights } = await supabase
        .from("location_highlights")
        .select(
          `
          id,
          icon,
          order_index,
          location_highlight_translations!inner (
            language_code,
            title,
            value
          )
        `
        )
        .eq("location_id", locationId)
        .eq("location_highlight_translations.language_code", "ka")
        .order("order_index");

      // Load tips
      const { data: tips } = await supabase
        .from("location_tips")
        .select(
          `
          id,
          order_index,
          location_tip_translations!inner (
            language_code,
            tip
          )
        `
        )
        .eq("location_id", locationId)
        .eq("location_tip_translations.language_code", "ka")
        .order("order_index");

      // Populate draft
      setDraft({
        // Basic
        locationId: loc.id,
        altitude: loc.card_altitude || 0,

        // Images
        heroImage: null,
        heroImageUrl: loc.hero_bg || "",
        cardImage: null,
        cardImageUrl: loc.card_thumbnail || "",

        // Gallery
        galleryImages: [],
        existingGalleryUrls: loc.gallery_urls || [],

        // Hero
        slogan: translation.hero_headline || "",
        mainText: translation.hero_tagline || "",
        overlayTitle: translation.hero_overlay_title || "",
        overlayDesc: translation.hero_overlay_desc || "",

        // Card
        description: translation.card_tagline || "",
        region: translation.card_region || "",

        // Info
        infoCardTitle: translation.info_title || "",
        infoCardText: translation.info_intro || "",

        // Highlights
        highlights:
          highlights?.map((h) => ({
            id: h.id,
            title: h.location_highlight_translations[0]?.title || "",
            value: h.location_highlight_translations[0]?.value || "",
            icon: h.icon || "",
          })) || [],

        // Tips
        tips:
          tips?.map((t) => ({
            id: t.id,
            text: t.location_tip_translations[0]?.tip || "",
          })) || [],

        // Legacy
        tags: [],

        // Flight packages
        flights:
          flights?.map((f) => ({
            id: f.id,
            key: f.fly_type_id,
            title: f.location_fly_type_translations[0]?.name || "",
            description: f.location_fly_type_translations[0]?.description || "",
            info: "",
            price: f.price?.toString() || "",
            discount: "",
            features: f.location_fly_type_translations[0]?.features || [],
          })) || [],

        // Sections
        sections:
          sections?.map((s, idx) => ({
            id: s.id.toString(),
            heading: s.location_section_translations[0]?.title || "",
            body: s.location_section_translations[0]?.content || "",
            images: [],
            existingImages: [],
          })) || [],
      });

      setFormStatus("‚úÖ ·É©·Éê·Éò·É¢·Éï·Éò·É†·Éó·Éê!");
    } catch (err: any) {
      console.error("Load for edit error:", err);
      setFormStatus(`‚ùå ·É©·Éê·É¢·Éï·Éò·É†·Éó·Éï·Éò·É° ·É®·Éî·É™·Éì·Éù·Éõ·Éê: ${err.message}`);
    } finally {
      setFormSaving(false);
    }
  };

  // ============ FORM FUNCTIONS ============

  const update = <K extends keyof LocationDraft>(
    field: K,
    value: LocationDraft[K]
  ) => {
    setDraft((d) => ({ ...d, [field]: value }));
  };

  const updateFlight = (
    key: string,
    field: keyof FlightPackage,
    value: string
  ) => {
    setDraft((d) => ({
      ...d,
      flights: d.flights.map((f) =>
        f.key === key ? { ...f, [field]: value } : f
      ),
    }));
  };

  const addFlightFeature = (flightKey: string) => {
    setDraft((d) => ({
      ...d,
      flights: d.flights.map((f) =>
        f.key === flightKey ? { ...f, features: [...f.features, ""] } : f
      ),
    }));
  };

  const updateFlightFeature = (
    flightKey: string,
    featureIndex: number,
    value: string
  ) => {
    setDraft((d) => ({
      ...d,
      flights: d.flights.map((f) =>
        f.key === flightKey
          ? {
              ...f,
              features: f.features.map((feat, i) =>
                i === featureIndex ? value : feat
              ),
            }
          : f
      ),
    }));
  };

  const removeFlightFeature = (flightKey: string, featureIndex: number) => {
    setDraft((d) => ({
      ...d,
      flights: d.flights.map((f) =>
        f.key === flightKey
          ? { ...f, features: f.features.filter((_, i) => i !== featureIndex) }
          : f
      ),
    }));
  };

  const updateSection = (
    id: string,
    field: keyof LocationSection,
    value: any
  ) => {
    setDraft((d) => ({
      ...d,
      sections: d.sections.map((s) =>
        s.id === id ? { ...s, [field]: value } : s
      ),
    }));
  };

  const handleHeroImage = (file: File | null) => update("heroImage", file);
  const handleCardImage = (file: File | null) => update("cardImage", file);

  const handleGalleryImages = (files: FileList | null) => {
    if (!files || !files.length) return;
    setDraft((d) => ({
      ...d,
      galleryImages: [...d.galleryImages, ...Array.from(files)],
    }));
  };

  const removeGalleryImage = (index: number) => {
    setDraft((d) => ({
      ...d,
      galleryImages: d.galleryImages.filter((_, i) => i !== index),
    }));
  };

  const removeExistingGalleryImage = (url: string) => {
    setDraft((d) => ({
      ...d,
      existingGalleryUrls: d.existingGalleryUrls.filter((u) => u !== url),
    }));
  };

  const addHighlight = () => {
    setDraft((d) => ({
      ...d,
      highlights: [...d.highlights, { title: "", value: "", icon: "üìç" }],
    }));
  };

  const updateHighlight = (
    index: number,
    field: "title" | "value" | "icon",
    value: string
  ) => {
    setDraft((d) => ({
      ...d,
      highlights: d.highlights.map((h, i) =>
        i === index ? { ...h, [field]: value } : h
      ),
    }));
  };

  const removeHighlight = (index: number) => {
    setDraft((d) => ({
      ...d,
      highlights: d.highlights.filter((_, i) => i !== index),
    }));
  };

  const addTip = () => {
    setDraft((d) => ({
      ...d,
      tips: [...d.tips, { text: "" }],
    }));
  };

  const updateTip = (index: number, text: string) => {
    setDraft((d) => ({
      ...d,
      tips: d.tips.map((t, i) => (i === index ? { ...t, text } : t)),
    }));
  };

  const removeTip = (index: number) => {
    setDraft((d) => ({
      ...d,
      tips: d.tips.filter((_, i) => i !== index),
    }));
  };

  const addSectionImage = (id: string, files: FileList | null) => {
    if (!files || !files.length) return;
    setDraft((d) => ({
      ...d,
      sections: d.sections.map((s) =>
        s.id === id ? { ...s, images: [...s.images, ...Array.from(files)] } : s
      ),
    }));
  };

  const removeSectionImage = (id: string, index: number) => {
    setDraft((d) => ({
      ...d,
      sections: d.sections.map((s) =>
        s.id === id
          ? { ...s, images: s.images.filter((_, i) => i !== index) }
          : s
      ),
    }));
  };

  const addTag = () => {
    const t = tagInput.trim();
    if (!t || draft.tags.includes(t)) return;
    setDraft((d) => ({ ...d, tags: [...d.tags, t] }));
    setTagInput("");
  };

  const removeTag = (t: string) => {
    setDraft((d) => ({ ...d, tags: d.tags.filter((x) => x !== t) }));
  };

  // ============ SUBMIT (CREATE/UPDATE) ============

  const submit = async (e: React.FormEvent) => {
    e.preventDefault();

    if (!draft.locationId.trim()) {
      setFormStatus("‚ùå Location ID ·Éê·É£·É™·Éò·Éö·Éî·Éë·Éî·Éö·Éò·Éê");
      return;
    }
    if (!draft.slogan.trim()) {
      setFormStatus("‚ùå ·É°·Éö·Éù·Éí·Éê·Éú·Éò ·Éê·É£·É™·Éò·Éö·Éî·Éë·Éî·Éö·Éò·Éê");
      return;
    }
    if (viewMode === "create" && !draft.heroImage) {
      setFormStatus("‚ùå ·Éê·É¢·Éï·Éò·É†·Éó·Éî hero ·É°·É£·É†·Éê·Éó·Éò");
      return;
    }

    setFormSaving(true);
    setFormStatus("üíæ ·É®·Éî·Éú·Éê·ÉÆ·Éï·Éê...");

    try {
      const supabase = createSupabaseBrowserClient();
      const locationId = draft.locationId.toLowerCase().replace(/\s+/g, "-");

      let heroUrl = draft.heroImageUrl;
      let cardUrl = draft.cardImageUrl;

      // Upload new images if provided
      if (draft.heroImage) {
        setFormStatus("üì§ Hero ·É°·É£·É†·Éê·Éó·Éò·É° ·Éê·É¢·Éï·Éò·É†·Éó·Éï·Éê...");
        const result = await uploadLocationImage(
          draft.heroImage,
          locationId,
          "hero"
        );
        if (result.error) throw new Error(result.error);
        heroUrl = result.url;
      }

      if (draft.cardImage) {
        setFormStatus("üì§ Card ·É°·É£·É†·Éê·Éó·Éò·É° ·Éê·É¢·Éï·Éò·É†·Éó·Éï·Éê...");
        const result = await uploadLocationImage(
          draft.cardImage,
          locationId,
          "thumbnails"
        );
        if (!result.error) cardUrl = result.url;
      }

      // Upload section images
      const sectionImageUrls: Record<string, string[]> = {};
      for (const section of draft.sections) {
        if (section.images.length > 0) {
          const results = await uploadMultipleLocationImages(
            section.images,
            locationId,
            "gallery"
          );
          sectionImageUrls[section.id] = results
            .filter((r) => !r.error)
            .map((r) => r.url);
        }
      }

      if (viewMode === "edit") {
        // UPDATE mode
        setFormStatus("üíæ ·Éö·Éù·Éô·Éê·É™·Éò·Éò·É° ·Éí·Éê·Éú·Éê·ÉÆ·Éö·Éî·Éë·Éê...");

        const { error: updateError } = await supabase
          .from("locations")
          .update({
            hero_bg: heroUrl,
            hero_thumb: cardUrl || heroUrl,
            hero_thumb_webp: cardUrl || heroUrl,
            card_thumbnail: cardUrl || heroUrl,
            card_thumbnail_webp: cardUrl || heroUrl,
            card_altitude: draft.altitude || 0,
          })
          .eq("id", locationId);

        if (updateError) throw updateError;

        // Update translation
        await supabase
          .from("location_translations")
          .update({
            hero_headline: draft.slogan,
            hero_tagline: draft.mainText,
            hero_overlay_title: draft.overlayTitle,
            hero_overlay_desc: draft.overlayDesc,
            card_name: draft.slogan,
            card_region: draft.region,
            card_tagline: draft.description,
            info_title: draft.infoCardTitle,
            info_intro: draft.infoCardText,
          })
          .eq("location_id", locationId)
          .eq("language_code", "ka");

        // UPDATE sections: Delete old ones and insert new ones
        // (Simple approach - more sophisticated would be UPDATE existing)
        await supabase
          .from("location_sections")
          .delete()
          .eq("location_id", locationId);

        for (const section of draft.sections) {
          if (!section.heading) continue;

          const { data: secData } = await supabase
            .from("location_sections")
            .insert({
              location_id: locationId,
              order_index: draft.sections.indexOf(section),
            })
            .select()
            .single();

          if (secData) {
            await supabase.from("location_section_translations").insert({
              section_id: secData.id,
              language_code: "ka",
              title: section.heading,
              content: section.body,
            });
          }
        }

        // UPDATE highlights: Delete old and insert new
        await supabase
          .from("location_highlights")
          .delete()
          .eq("location_id", locationId);

        for (const highlight of draft.highlights) {
          if (!highlight.title || !highlight.value) continue;

          const { data: highlightData } = await supabase
            .from("location_highlights")
            .insert({
              location_id: locationId,
              icon: highlight.icon || "üìç",
              order_index: draft.highlights.indexOf(highlight),
            })
            .select()
            .single();

          if (highlightData) {
            await supabase.from("location_highlight_translations").insert({
              highlight_id: highlightData.id,
              language_code: "ka",
              title: highlight.title,
              value: highlight.value,
            });
          }
        }

        // UPDATE tips: Delete old and insert new
        await supabase
          .from("location_tips")
          .delete()
          .eq("location_id", locationId);

        for (const tip of draft.tips) {
          if (!tip.text) continue;

          const { data: tipData } = await supabase
            .from("location_tips")
            .insert({
              location_id: locationId,
              order_index: draft.tips.indexOf(tip),
            })
            .select()
            .single();

          if (tipData) {
            await supabase.from("location_tip_translations").insert({
              tip_id: tipData.id,
              language_code: "ka",
              tip: tip.text,
            });
          }
        }

        // UPDATE fly_types: Delete old and insert new
        await supabase
          .from("location_fly_types")
          .delete()
          .eq("location_id", locationId);

        for (const flight of draft.flights) {
          if (!flight.title || !flight.price) continue;

          const { data: flyData } = await supabase
            .from("location_fly_types")
            .insert({
              location_id: locationId,
              fly_type_id: flight.key,
              duration: "30-60 ·É¨·É£·Éó·Éò",
              price: parseFloat(flight.price) || 0,
              recommended: flight.key === "standard",
              order_index: draft.flights.indexOf(flight),
            })
            .select()
            .single();

          if (flyData) {
            await supabase.from("location_fly_type_translations").insert({
              fly_type_id: flyData.id,
              language_code: "ka",
              name: flight.title,
              description: flight.description || "",
              features: flight.features || [],
            });
          }
        }

        // UPDATE gallery: Upload new images and merge with existing
        let finalGalleryUrls = [...draft.existingGalleryUrls];

        if (draft.galleryImages.length > 0) {
          setFormStatus("üì∏ ·Éê·ÉÆ·Éê·Éö·Éò ·Éí·Éê·Éö·Éî·É†·Éî·Éò·É° ·É°·É£·É†·Éê·Éó·Éî·Éë·Éò·É° ·Éê·É¢·Éï·Éò·É†·Éó·Éï·Éê...");

          const galleryResults = await uploadMultipleLocationImages(
            draft.galleryImages,
            locationId,
            "gallery"
          );

          // Add new URLs to gallery array
          for (const result of galleryResults) {
            if (!result.error) {
              finalGalleryUrls.push(result.url);
            } else {
              console.error("Gallery upload error:", result.error);
            }
          }
        }

        // Update gallery_urls in locations table
        await supabase
          .from("locations")
          .update({
            gallery_urls: finalGalleryUrls,
          })
          .eq("id", locationId);

        setFormStatus("‚úÖ ·Éö·Éù·Éô·Éê·É™·Éò·Éê ·Éí·Éê·Éú·Éê·ÉÆ·Éö·Éì·Éê!");
      } else {
        // CREATE mode
        setFormStatus("üíæ ·Éê·ÉÆ·Éê·Éö·Éò ·Éö·Éù·Éô·Éê·É™·Éò·Éò·É° ·É®·Éî·É•·Éõ·Éú·Éê...");

        const { error: insertError } = await supabase.from("locations").insert({
          id: locationId,
          href: `/locations/${locationId}`,
          hero_bg: heroUrl,
          hero_thumb: cardUrl || heroUrl,
          hero_thumb_webp: cardUrl || heroUrl,
          hero_pin: true,
          card_thumbnail: cardUrl || heroUrl,
          card_thumbnail_webp: cardUrl || heroUrl,
          card_status: "active",
          card_altitude: draft.altitude || 0,
          card_active: true,
          is_published: true,
        });

        if (insertError) throw insertError;

        // Insert translation
        await supabase.from("location_translations").insert({
          location_id: locationId,
          language_code: "ka",
          hero_headline: draft.slogan,
          hero_tagline: draft.mainText,
          hero_overlay_title: draft.overlayTitle,
          hero_overlay_desc: draft.overlayDesc,
          card_name: draft.slogan,
          card_region: draft.region,
          card_tagline: draft.description,
          info_title: draft.infoCardTitle,
          info_intro: draft.infoCardText,
        });

        // Insert flights
        for (const flight of draft.flights) {
          if (!flight.title || !flight.price) continue;

          const { data: flyData } = await supabase
            .from("location_fly_types")
            .insert({
              location_id: locationId,
              fly_type_id: flight.key,
              duration: "30-60 ·É¨·É£·Éó·Éò",
              price: parseFloat(flight.price) || 0,
              recommended: flight.key === "standard",
              order_index: draft.flights.indexOf(flight),
            })
            .select()
            .single();

          if (flyData) {
            await supabase.from("location_fly_type_translations").insert({
              fly_type_id: flyData.id,
              language_code: "ka",
              name: flight.title,
              description: flight.description || "",
              features: flight.features || [],
            });
          }
        }

        // Insert sections
        for (const section of draft.sections) {
          if (!section.heading) continue;

          const { data: secData } = await supabase
            .from("location_sections")
            .insert({
              location_id: locationId,
              order_index: draft.sections.indexOf(section),
            })
            .select()
            .single();

          if (secData) {
            await supabase.from("location_section_translations").insert({
              section_id: secData.id,
              language_code: "ka",
              title: section.heading,
              content: section.body,
            });
          }
        }

        // Insert highlights
        for (const highlight of draft.highlights) {
          if (!highlight.title || !highlight.value) continue;

          const { data: highlightData } = await supabase
            .from("location_highlights")
            .insert({
              location_id: locationId,
              icon: highlight.icon || "üìç",
              order_index: draft.highlights.indexOf(highlight),
            })
            .select()
            .single();

          if (highlightData) {
            await supabase.from("location_highlight_translations").insert({
              highlight_id: highlightData.id,
              language_code: "ka",
              title: highlight.title,
              value: highlight.value,
            });
          }
        }

        // Insert tips
        for (const tip of draft.tips) {
          if (!tip.text) continue;

          const { data: tipData } = await supabase
            .from("location_tips")
            .insert({
              location_id: locationId,
              order_index: draft.tips.indexOf(tip),
            })
            .select()
            .single();

          if (tipData) {
            await supabase.from("location_tip_translations").insert({
              tip_id: tipData.id,
              language_code: "ka",
              tip: tip.text,
            });
          }
        }

        // Upload gallery images to Storage and save URLs in locations table
        let galleryUrls: string[] = [];

        if (draft.galleryImages.length > 0) {
          setFormStatus("üì∏ ·Éí·Éê·Éö·Éî·É†·Éî·Éò·É° ·É°·É£·É†·Éê·Éó·Éî·Éë·Éò·É° ·Éê·É¢·Éï·Éò·É†·Éó·Éï·Éê...");

          const galleryResults = await uploadMultipleLocationImages(
            draft.galleryImages,
            locationId,
            "gallery"
          );

          // Collect successful URLs
          galleryUrls = galleryResults
            .filter((r) => !r.error)
            .map((r) => r.url);

          if (galleryUrls.length > 0) {
            // Update locations table with gallery URLs
            await supabase
              .from("locations")
              .update({
                gallery_urls: galleryUrls,
              })
              .eq("id", locationId);
          }
        }

        setFormStatus("‚úÖ ·Éö·Éù·Éô·Éê·É™·Éò·Éê ·Éì·Éê·Éõ·Éê·É¢·Éî·Éë·É£·Éö·Éò·Éê!");
      }

      setTimeout(() => {
        backToList();
      }, 1500);
    } catch (err: any) {
      console.error("Submit error:", err);
      setFormStatus(`‚ùå ·É®·Éî·É™·Éì·Éù·Éõ·Éê: ${err.message}`);
    } finally {
      setFormSaving(false);
    }
  };

  // ============ RENDER ============

  if (viewMode === "list") {
    return (
      <div className={styles.wrapper}>
        <div className={styles.listHeader}>
          <h2 className={styles.title}>·Éö·Éù·Éô·Éê·É™·Éò·Éî·Éë·Éò·É° ·Éõ·Éê·É†·Éó·Éï·Éê</h2>
          <button
            onClick={handleCreateNew}
            className={`${styles.btn} ${styles.primary}`}
          >
            + ·Éê·ÉÆ·Éê·Éö·Éò ·Éö·Éù·Éô·Éê·É™·Éò·Éê
          </button>
        </div>

        {listLoading && <div className={styles.loading}>·Éò·É¢·Éï·Éò·É†·Éó·Éî·Éë·Éê...</div>}
        {listError && <div className={styles.error}>‚ùå {listError}</div>}

        {!listLoading && !listError && locations.length === 0 && (
          <div className={styles.empty}>
            <p>·Éö·Éù·Éô·Éê·É™·Éò·Éî·Éë·Éò ·Éê·É† ·Éê·É†·Éò·É°</p>
            <button
              onClick={handleCreateNew}
              className={`${styles.btn} ${styles.primary}`}
            >
              ·Éì·Éê·Éê·Éõ·Éê·É¢·Éî ·Éû·Éò·É†·Éï·Éî·Éö·Éò ·Éö·Éù·Éô·Éê·É™·Éò·Éê
            </button>
          </div>
        )}

        {!listLoading && locations.length > 0 && (
          <div className={styles.tableWrapper}>
            <table className={styles.table}>
              <thead>
                <tr>
                  <th>ID</th>
                  <th>·Éì·Éê·É°·Éê·ÉÆ·Éî·Éö·Éî·Éë·Éê</th>
                  <th>·É°·Éò·Éõ·Éê·É¶·Éö·Éî</th>
                  <th>·É°·É¢·Éê·É¢·É£·É°·Éò</th>
                  <th>·Éí·Éê·Éõ·Éù·É•·Éï·Éî·Éß·Éú·Éî·Éë·É£·Éö·Éò</th>
                  <th>·Éõ·Éù·É•·Éõ·Éî·Éì·Éî·Éë·Éî·Éë·Éò</th>
                </tr>
              </thead>
              <tbody>
                {locations.map((loc) => {
                  const trans = loc.location_translations[0];
                  return (
                    <tr key={loc.id}>
                      <td className={styles.idCell}>{loc.id}</td>
                      <td>
                        <strong>{trans?.card_name || "-"}</strong>
                        <br />
                        <small>{trans?.hero_headline || "-"}</small>
                      </td>
                      <td>{loc.card_altitude}m</td>
                      <td>
                        <span
                          className={`${styles.badge} ${
                            styles[loc.card_status]
                          }`}
                        >
                          {loc.card_status}
                        </span>
                      </td>
                      <td>
                        <button
                          className={`${styles.toggleBtn} ${
                            loc.is_published ? styles.published : styles.draft
                          }`}
                          onClick={() =>
                            handleTogglePublish(loc.id, loc.is_published)
                          }
                        >
                          {loc.is_published ? "‚úÖ" : "üîí"}
                        </button>
                      </td>
                      <td className={styles.actionsCell}>
                        <button
                          onClick={() => handleEdit(loc.id)}
                          className={styles.editBtn}
                        >
                          ‚úèÔ∏è Edit
                        </button>
                        <button
                          onClick={() => handleDelete(loc.id)}
                          className={styles.deleteBtn}
                        >
                          üóëÔ∏è Delete
                        </button>
                      </td>
                    </tr>
                  );
                })}
              </tbody>
            </table>
          </div>
        )}
      </div>
    );
  }

  // FORM VIEW (create or edit)
  return (
    <div className={styles.wrapper}>
      <div className={styles.formHeader}>
        <button onClick={backToList} className={styles.backBtn}>
          ‚Üê ·É£·Éô·Éê·Éú
        </button>
        <h2 className={styles.title}>
          {viewMode === "edit"
            ? `·É†·Éî·Éì·Éê·É•·É¢·Éò·É†·Éî·Éë·Éê: ${draft.locationId}`
            : "·Éê·ÉÆ·Éê·Éö·Éò ·Éö·Éù·Éô·Éê·É™·Éò·Éê"}
        </h2>
      </div>

      <form onSubmit={submit} className={styles.form}>
        {/* 0Ô∏è‚É£ ·É´·Éò·É†·Éò·Éó·Éê·Éì·Éò ·Éò·Éú·É§·Éù */}
        <fieldset className={styles.fieldset}>
          <legend>0Ô∏è‚É£ ·É´·Éò·É†·Éò·Éó·Éê·Éì·Éò ·Éò·Éú·É§·Éù·É†·Éõ·Éê·É™·Éò·Éê</legend>
          <div className={styles.field}>
            <label htmlFor="loc-id">Location ID (slug) *</label>
            <input
              id="loc-id"
              value={draft.locationId}
              onChange={(e) =>
                update(
                  "locationId",
                  e.target.value.toLowerCase().replace(/\s+/g, "-")
                )
              }
              placeholder="gudauri, kazbegi..."
              disabled={viewMode === "edit"}
              required
            />
            <span className={styles.smallNote}>
              {viewMode === "edit"
                ? "‚ö†Ô∏è ID-·É° ·É™·Éï·Éö·Éò·Éö·Éî·Éë·Éê ·É®·Éî·É£·É´·Éö·Éî·Éë·Éî·Éö·Éò·Éê"
                : "URL: /locations/{id}"}
            </span>
          </div>
          <div className={styles.field}>
            <label htmlFor="loc-altitude">·É°·Éò·Éõ·Éê·É¶·Éö·Éî (·Éõ·Éî·É¢·É†·Éò)</label>
            <input
              id="loc-altitude"
              type="number"
              value={draft.altitude || 0}
              onChange={(e) =>
                update("altitude", parseInt(e.target.value) || 0)
              }
              placeholder="2196"
            />
          </div>
          <div className={styles.field}>
            <label htmlFor="loc-region">·É†·Éî·Éí·Éò·Éù·Éú·Éò *</label>
            <input
              id="loc-region"
              value={draft.region}
              onChange={(e) => update("region", e.target.value)}
              placeholder="·Éõ·É™·ÉÆ·Éî·Éó·Éê-·Éõ·Éó·Éò·Éê·Éú·Éî·Éó·Éò"
              required
            />
            <span className={styles.smallNote}>
              ·Éí·Éê·Éõ·Éù·Éò·Éß·Éî·Éú·Éî·Éë·Éê ·Éë·Éê·É†·Éê·Éó·Éñ·Éî ·Éì·Éê LocationsHero-·É®·Éò
            </span>
          </div>
        </fieldset>

        {/* 1Ô∏è‚É£ Hero Section - ·Éî·É°·Éî ·Éí·Éê·Éõ·Éù·É©·Éú·Éì·Éî·Éë·Éê ·Éí·Éï·Éî·É†·Éì·Éò·É° ·Éó·Éê·Éï·É®·Éò */}
        <fieldset className={styles.fieldset}>
          <legend>1Ô∏è‚É£ Hero Section (·Éõ·Éó·Éê·Éï·Éê·É†·Éò ·Éë·Éê·Éú·Éî·É†·Éò - LocationsHero)</legend>
          <div className={styles.fileInput}>
            <label>
              üñºÔ∏è Hero Background ·É°·É£·É†·Éê·Éó·Éò {viewMode === "create" && "*"}
            </label>
            <input
              type="file"
              accept="image/*"
              onChange={(e) => handleHeroImage(e.target.files?.[0] || null)}
            />
            {draft.heroImage && (
              <span className={styles.smallNote}>
                ‚úÖ {draft.heroImage.name}
              </span>
            )}
            {draft.heroImageUrl && !draft.heroImage && (
              <span className={styles.smallNote}>
                ·Éê·Éõ·Éü·Éê·Éõ·Éò·Éú·Éì·Éî·Éö·Éò: {draft.heroImageUrl.split("/").pop()}
              </span>
            )}

            {/* Preview */}
            {(draft.heroImage || draft.heroImageUrl) && (
              <div className={styles.imagePreviewWrapper}>
                {/* eslint-disable-next-line @next/next/no-img-element */}
                <img
                  src={
                    draft.heroImage
                      ? URL.createObjectURL(draft.heroImage)
                      : draft.heroImageUrl
                  }
                  alt="Hero preview"
                />
              </div>
            )}
          </div>
          <div className={styles.field}>
            <label htmlFor="loc-slogan">üìå Headline (·Éõ·Éó·Éê·Éï·Éê·É†·Éò ·É°·Éê·Éó·Éê·É£·É†·Éò) *</label>
            <input
              id="loc-slogan"
              value={draft.slogan}
              onChange={(e) => update("slogan", e.target.value)}
              placeholder="·Éí·É£·Éì·Éê·É£·É†·Éò"
              required
            />
            <span className={styles.smallNote}>
              ·É©·Éú·Éì·Éî·Éë·Éê Hero ·Éë·Éê·Éú·Éî·É†·Éñ·Éî ·Éì·Éò·Éì·Éò ·É¢·Éî·É•·É°·É¢·Éò·Éó + ·Éí·Éê·Éõ·Éù·Éò·Éß·Éî·Éú·Éî·Éë·Éê card name-·Éê·Éì
            </span>
          </div>
          <div className={styles.field}>
            <label htmlFor="loc-maintext">üìù Tagline (·É•·Éï·Éî·É¨·Éê·É†·É¨·Éî·É†·Éê)</label>
            <textarea
              id="loc-maintext"
              rows={2}
              value={draft.mainText}
              onChange={(e) => update("mainText", e.target.value)}
              placeholder="·Éû·Éê·É†·Éê·Éí·Éö·Éê·Éò·Éì·Éò·Éú·Éí·Éò ·Éô·Éê·Éï·Éô·Éê·É°·Éò·Éù·Éú·Éñ·Éî"
            />
            <span className={styles.smallNote}>·É©·Éú·Éì·Éî·Éë·Éê Headline-·Éò·É° ·É•·Éï·Éî·Éõ·Éù·Éó</span>
          </div>
          <div className={styles.field}>
            <label htmlFor="loc-overlay-title">üè∑Ô∏è Overlay ·É°·Éê·Éó·Éê·É£·É†·Éò</label>
            <input
              id="loc-overlay-title"
              value={draft.overlayTitle}
              onChange={(e) => update("overlayTitle", e.target.value)}
              placeholder="·Éì·Éê·ÉØ·Éê·Éï·É®·Éú·Éî ·É§·É†·Éî·Éú·Éê"
            />
            <span className={styles.smallNote}>
              ·É©·Éú·Éì·Éî·Éë·Éê Hero ·É°·Éî·É•·É™·Éò·Éê·É®·Éò overlay ·É°·Éê·ÉÆ·Éò·Éó (·É§·Éê·É°·Éî·Éë·Éò·É° ·Éó·Éê·Éï·Éñ·Éî)
            </span>
          </div>
          <div className={styles.field}>
            <label htmlFor="loc-overlay-desc">üìÑ Overlay ·Éê·É¶·É¨·Éî·É†·Éê</label>
            <textarea
              id="loc-overlay-desc"
              rows={2}
              value={draft.overlayDesc}
              onChange={(e) => update("overlayDesc", e.target.value)}
              placeholder="·Éê·Éò·É†·É©·Éò·Éî ·É®·Éî·Éú·Éó·Éï·Éò·É° ·É°·Éê·É°·É£·É†·Éï·Éî·Éö·Éò ·Éû·Éê·Éô·Éî·É¢·Éò"
            />
            <span className={styles.smallNote}>
              ·Éì·Éê·Éõ·Éê·É¢·Éî·Éë·Éò·Éó·Éò ·É¢·Éî·É•·É°·É¢·Éò overlay-·É®·Éò
            </span>
          </div>
        </fieldset>

        {/* 2Ô∏è‚É£ Gallery - ·É°·É£·É†·Éê·Éó·Éî·Éë·Éò·É° ·Éí·Éê·Éö·Éî·É†·Éî·Éê */}
        <fieldset className={styles.fieldset}>
          <legend>2Ô∏è‚É£ Gallery (·É°·É£·É†·Éê·Éó·Éî·Éë·Éò·É° ·Éí·Éê·Éö·Éî·É†·Éî·Éê - Gallery ·Éô·Éù·Éõ·Éû·Éù·Éú·Éî·Éú·É¢·Éò)</legend>
          <p className={styles.smallNote}>
            ·Éî·É° ·É°·É£·É†·Éê·Éó·Éî·Éë·Éò ·Éí·Éê·Éõ·Éù·É©·Éú·Éì·Éî·Éë·Éê Gallery ·Éô·Éù·Éõ·Éû·Éù·Éú·Éî·Éú·É¢·É®·Éò (·É°·É£·É†·Éê·Éó·Éî·Éë·Éò·É° grid)
          </p>

          <div className={styles.fileInput}>
            <label>üñºÔ∏è ·Éí·Éê·Éö·Éî·É†·Éî·Éò·É° ·É°·É£·É†·Éê·Éó·Éî·Éë·Éò (multiple)</label>
            <input
              type="file"
              multiple
              accept="image/*"
              onChange={(e) => handleGalleryImages(e.target.files)}
            />
            <span className={styles.smallNote}>
              ·É®·Éî·Éí·Éò·É´·Éö·Éò·Éê ·Éî·É†·Éó·Éì·É†·Éù·É£·Éö·Éê·Éì ·É†·Éê·Éõ·Éì·Éî·Éú·Éò·Éõ·Éî ·É°·É£·É†·Éê·Éó·Éò·É° ·Éê·É¢·Éï·Éò·É†·Éó·Éï·Éê
            </span>
          </div>

          {/* ·Éê·É†·É°·Éî·Éë·É£·Éö·Éò ·É°·É£·É†·Éê·Éó·Éî·Éë·Éò (EDIT mode) */}
          {draft.existingGalleryUrls.length > 0 && (
            <div className={styles.field}>
              <label>üì∑ ·Éê·É†·É°·Éî·Éë·É£·Éö·Éò ·É°·É£·É†·Éê·Éó·Éî·Éë·Éò</label>
              <div className={styles.imagesRow}>
                {draft.existingGalleryUrls.map((url, i) => (
                  <div key={i} className={styles.imagePreviewWrapper}>
                    {/* eslint-disable-next-line @next/next/no-img-element */}
                    <img src={url} alt={`Gallery ${i + 1}`} />
                    <button
                      type="button"
                      className={styles.removeImageBtn}
                      onClick={() => removeExistingGalleryImage(url)}
                      title="·É¨·Éê·É®·Éö·Éê"
                    >
                      √ó
                    </button>
                  </div>
                ))}
              </div>
            </div>
          )}

          {/* ·Éê·ÉÆ·Éê·Éö·Éò ·É°·É£·É†·Éê·Éó·Éî·Éë·Éò (preview) */}
          {draft.galleryImages.length > 0 && (
            <div className={styles.field}>
              <label>‚ú® ·Éê·ÉÆ·Éê·Éö·Éò ·É°·É£·É†·Éê·Éó·Éî·Éë·Éò (preview)</label>
              <div className={styles.imagesRow}>
                {draft.galleryImages.map((file, i) => (
                  <div key={i} className={styles.imagePreviewWrapper}>
                    {/* eslint-disable-next-line @next/next/no-img-element */}
                    <img src={URL.createObjectURL(file)} alt={file.name} />
                    <button
                      type="button"
                      className={styles.removeImageBtn}
                      onClick={() => removeGalleryImage(i)}
                      title="·É¨·Éê·É®·Éö·Éê"
                    >
                      √ó
                    </button>
                  </div>
                ))}
              </div>
            </div>
          )}
        </fieldset>

        {/* 3Ô∏è‚É£ Location Info - ·Éì·Éî·É¢·Éê·Éö·É£·É†·Éò ·Éò·Éú·É§·Éù·É†·Éõ·Éê·É™·Éò·Éê */}
        <fieldset className={styles.fieldset}>
          <legend>
            3Ô∏è‚É£ Location Info (·Éì·Éî·É¢·Éê·Éö·É£·É†·Éò ·Éò·Éú·É§·Éù·É†·Éõ·Éê·É™·Éò·Éê - LocationDetails ·Éô·Éù·Éõ·Éû·Éù·Éú·Éî·Éú·É¢·Éò)
          </legend>
          <p className={styles.smallNote}>
            ·Éî·É° ·É°·Éî·É•·É™·Éò·Éê ·É©·Éú·Éì·Éî·Éë·Éê ·Éí·Éï·Éî·É†·Éì·Éñ·Éî Gallery-·Éò·É° ·É®·Éî·Éõ·Éì·Éî·Éí, ·É®·Éî·Éò·É™·Éê·Éï·É° ·Éì·Éî·É¢·Éê·Éö·É£·É† ·Éê·É¶·É¨·Éî·É†·Éê·É°,
            ·É°·Éî·É•·É™·Éò·Éî·Éë·É°, highlights ·Éì·Éê tips
          </p>

          <div className={styles.field}>
            <label htmlFor="info-title">üìã Info ·É°·Éê·Éó·Éê·É£·É†·Éò</label>
            <input
              id="info-title"
              value={draft.infoCardTitle}
              onChange={(e) => update("infoCardTitle", e.target.value)}
              placeholder="·Éö·Éù·Éô·Éê·É™·Éò·Éò·É° ·É®·Éî·É°·Éê·ÉÆ·Éî·Éë"
            />
            <span className={styles.smallNote}>
              ·É©·Éú·Éì·Éî·Éë·Éê LocationDetails-·Éò·É° ·Éó·Éê·Éï·É®·Éò
            </span>
          </div>
          <div className={styles.field}>
            <label htmlFor="info-intro">üìù Info ·É®·Éî·É°·Éê·Éï·Éê·Éö·Éò ·É¢·Éî·É•·É°·É¢·Éò</label>
            <textarea
              id="info-intro"
              rows={3}
              value={draft.infoCardText}
              onChange={(e) => update("infoCardText", e.target.value)}
              placeholder="·É®·Éî·É°·Éê·Éï·Éê·Éö·Éò ·Éò·Éú·É§·Éù·É†·Éõ·Éê·É™·Éò·Éê ·Éö·Éù·Éô·Éê·É™·Éò·Éò·É° ·É®·Éî·É°·Éê·ÉÆ·Éî·Éë..."
            />
            <span className={styles.smallNote}>
              ·É®·Éî·É°·Éê·Éï·Éê·Éö·Éò ·Éê·Éë·Éñ·Éê·É™·Éò LocationDetails ·É°·Éî·É•·É™·Éò·Éê·É®·Éò
            </span>
          </div>

          <div className={styles.subsectionHeader}>
            üìö Sections (·Éì·Éî·É¢·Éê·Éö·É£·É†·Éò ·É°·Éî·É•·É™·Éò·Éî·Éë·Éò)
          </div>
          <div className={styles.stack}>
            {draft.sections.map((s, idx) => (
              <div key={s.id} className={styles.sectionGroup}>
                <div className={styles.sectionTitleRow}>
                  <div className={styles.sectionIndex}>{idx + 1}</div>
                  <input
                    className={styles.grow}
                    placeholder="·É°·Éî·É•·É™·Éò·Éò·É° ·É°·Éê·Éó·Éê·É£·É†·Éò"
                    value={s.heading}
                    onChange={(e) =>
                      updateSection(s.id, "heading", e.target.value)
                    }
                  />
                </div>
                <textarea
                  rows={4}
                  placeholder="·É°·Éî·É•·É™·Éò·Éò·É° ·É¢·Éî·É•·É°·É¢·Éò..."
                  value={s.body}
                  onChange={(e) => updateSection(s.id, "body", e.target.value)}
                />
                <div className={styles.fileInput}>
                  <label>üì∑ ·É°·É£·É†·Éê·Éó·Éî·Éë·Éò (·É°·Éî·É•·É™·Éò·Éò·É°·Éó·Éï·Éò·É°)</label>
                  <input
                    type="file"
                    multiple
                    accept="image/*"
                    onChange={(e) => addSectionImage(s.id, e.target.files)}
                  />
                  {s.images.length > 0 && (
                    <div className={styles.imagesRow}>
                      {s.images.map((f, i) => (
                        <div key={i} className={styles.imagePreviewWrapper}>
                          {/* eslint-disable-next-line @next/next/no-img-element */}
                          <img src={URL.createObjectURL(f)} alt={f.name} />
                          <button
                            type="button"
                            className={styles.removeImageBtn}
                            onClick={() => removeSectionImage(s.id, i)}
                          >
                            √ó
                          </button>
                        </div>
                      ))}
                    </div>
                  )}
                </div>
              </div>
            ))}
          </div>

          <div className={styles.subsectionHeader}>
            ‚≠ê Highlights (·É£·Éû·Éò·É†·Éê·É¢·Éî·É°·Éù·Éë·Éî·Éë·Éò)
          </div>
          <p className={styles.smallNote}>
            ·Éõ·Éê·Éí·Éê·Éö·Éò·Éó·Éê·Éì:
            <br />
            üìç ·É°·Éò·Éõ·Éê·É¶·Éö·Éî ‚Üí 2196 ·Éõ
            <br />
            üìÖ ·É§·É†·Éî·Éú·Éò·É° ·É°·Éî·Éñ·Éù·Éú·Éò ‚Üí ·Éê·Éû·É†·Éò·Éö·Éò-·Éú·Éù·Éî·Éõ·Éë·Éî·É†·Éò
            <br />
            üöó ·Éõ·Éê·Éú·É´·Éò·Éö·Éò ·Éó·Éë·Éò·Éö·Éò·É°·Éò·Éì·Éê·Éú ‚Üí 120 ·Éô·Éõ
            <br />
            ‚è±Ô∏è ·É§·É†·Éî·Éú·Éò·É° ·ÉÆ·Éê·Éú·Éí·É†·É´·Éö·Éò·Éï·Éù·Éë·Éê ‚Üí 15-50 ·É¨·É£·Éó·Éò
          </p>

          <div className={styles.stack}>
            {draft.highlights.map((h, idx) => (
              <div key={idx} className={styles.highlightRow}>
                <input
                  className={styles.iconInput}
                  placeholder="ÔøΩ"
                  value={h.icon}
                  onChange={(e) => updateHighlight(idx, "icon", e.target.value)}
                  maxLength={2}
                />
                <input
                  className={styles.grow}
                  placeholder="Title (·Éõ·Éê·Éí: ·É°·Éò·Éõ·Éê·É¶·Éö·Éî)"
                  value={h.title}
                  onChange={(e) =>
                    updateHighlight(idx, "title", e.target.value)
                  }
                />
                <input
                  className={styles.grow}
                  placeholder="Value (·Éõ·Éê·Éí: 2196 ·Éõ)"
                  value={h.value}
                  onChange={(e) =>
                    updateHighlight(idx, "value", e.target.value)
                  }
                />
                <button
                  type="button"
                  className={styles.removeBtn}
                  onClick={() => removeHighlight(idx)}
                  title="·É¨·Éê·É®·Éö·Éê"
                >
                  √ó
                </button>
              </div>
            ))}
            <button
              type="button"
              className={styles.addBtn}
              onClick={addHighlight}
            >
              + Highlight ·Éì·Éê·Éõ·Éê·É¢·Éî·Éë·Éê
            </button>
          </div>

          <div className={styles.subsectionHeader}>üí° Tips (·É†·É©·Éî·Éï·Éî·Éë·Éò)</div>
          <p className={styles.smallNote}>
            ·Éõ·Éê·É†·É¢·Éò·Éï·Éò ·É†·É©·Éî·Éï·Éî·Éë·Éò ·Éï·Éò·Éñ·Éò·É¢·Éù·É†·Éî·Éë·Éò·É°·Éó·Éï·Éò·É°, ·Éõ·Éê·Éí·Éê·Éö·Éò·Éó·Éê·Éì: &ldquo;·Éì·Éò·Éö·Éò·É° ·É°·Éê·Éê·Éó·Éî·Éë·Éò
            ·É°·Éê·É£·Éô·Éî·Éó·Éî·É°·Éù·Éê ·É§·É†·Éî·Éú·Éò·É°·Éó·Éï·Éò·É°&rdquo;
          </p>

          <div className={styles.stack}>
            {draft.tips.map((tip, idx) => (
              <div key={idx} className={styles.tipRow}>
                <input
                  className={styles.grow}
                  placeholder={`·É†·É©·Éî·Éï·Éê ${idx + 1}`}
                  value={tip.text}
                  onChange={(e) => updateTip(idx, e.target.value)}
                />
                <button
                  type="button"
                  className={styles.removeBtn}
                  onClick={() => removeTip(idx)}
                  title="·É¨·Éê·É®·Éö·Éê"
                >
                  √ó
                </button>
              </div>
            ))}
            <button type="button" className={styles.addBtn} onClick={addTip}>
              + Tip ·Éì·Éê·Éõ·Éê·É¢·Éî·Éë·Éê
            </button>
          </div>
        </fieldset>

        {/* 4Ô∏è‚É£ Flight Types - ·É§·É†·Éî·Éú·Éò·É° ·Éû·Éê·Éô·Éî·É¢·Éî·Éë·Éò */}
        <fieldset className={styles.fieldset}>
          <legend>
            4Ô∏è‚É£ Flight Types (·É§·É†·Éî·Éú·Éò·É° ·Éû·Éê·Éô·Éî·É¢·Éî·Éë·Éò - FlyTypes ·Éô·Éù·Éõ·Éû·Éù·Éú·Éî·Éú·É¢·Éò)
          </legend>
          <p className={styles.smallNote}>
            ·Éî·É° ·Éû·Éê·Éô·Éî·É¢·Éî·Éë·Éò ·É©·Éú·Éì·Éî·Éë·Éê ·É†·Éù·Éí·Éù·É†·É™ Hero Section-·É®·Éò (overlay-·É®·Éò ·É§·Éê·É°·Éî·Éë·Éò), ·Éê·É°·Éî·Éï·Éî
            FlyTypes ·Éô·Éù·Éõ·Éû·Éù·Éú·Éî·Éú·É¢·É®·Éò
          </p>
          <div className={styles.twoCol}>
            {draft.flights.map((f) => (
              <div key={f.key} className={styles.flightBlock}>
                <div className={styles.flightHeader}>‚úàÔ∏è {f.title}</div>
                <div className={styles.field}>
                  <label>·Éê·É¶·É¨·Éî·É†·Éê</label>
                  <textarea
                    rows={3}
                    value={f.description}
                    onChange={(e) =>
                      updateFlight(f.key, "description", e.target.value)
                    }
                    placeholder="·Éû·Éê·Éô·Éî·É¢·Éò·É° ·Éê·É¶·É¨·Éî·É†·Éê..."
                  />
                </div>
                <div className={styles.inlineInputs}>
                  <div className={styles.field}>
                    <label>üí∞ ·É§·Éê·É°·Éò (‚Çæ)</label>
                    <input
                      type="number"
                      value={f.price}
                      onChange={(e) =>
                        updateFlight(f.key, "price", e.target.value)
                      }
                      placeholder="0"
                    />
                  </div>
                </div>

                {/* Features (checkmarks) */}
                <div className={styles.field}>
                  <label>‚úì Features (·É£·Éû·Éò·É†·Éê·É¢·Éî·É°·Éù·Éë·Éî·Éë·Éò)</label>
                  {f.features.map((feature, idx) => (
                    <div key={idx} className={styles.featureRow}>
                      <input
                        className={styles.grow}
                        placeholder="·Éõ·Éê·Éí: ·Éí·Éê·Éõ·Éù·É™·Éì·Éò·Éö·Éò ·Éò·Éú·É°·É¢·É†·É£·É•·É¢·Éù·É†·Éò"
                        value={feature}
                        onChange={(e) =>
                          updateFlightFeature(f.key, idx, e.target.value)
                        }
                      />
                      <button
                        type="button"
                        className={styles.removeBtn}
                        onClick={() => removeFlightFeature(f.key, idx)}
                        title="·É¨·Éê·É®·Éö·Éê"
                      >
                        √ó
                      </button>
                    </div>
                  ))}
                  <button
                    type="button"
                    className={styles.addBtn}
                    onClick={() => addFlightFeature(f.key)}
                  >
                    + ·Éì·Éê·Éõ·Éê·É¢·Éî·Éë·Éê
                  </button>
                </div>
              </div>
            ))}
          </div>
        </fieldset>

        {/* 5Ô∏è‚É£ Card Settings - ·Éë·Éê·É†·Éê·Éó·Éò·É° ·Éû·Éê·É†·Éê·Éõ·Éî·É¢·É†·Éî·Éë·Éò */}
        <fieldset className={styles.fieldset}>
          <legend>
            5Ô∏è‚É£ Card Settings (·Éë·Éê·É†·Éê·Éó·Éò·É° ·Éû·Éê·É†·Éê·Éõ·Éî·É¢·É†·Éî·Éë·Éò - ActiveLocations ·Éô·Éù·Éõ·Éû·Éù·Éú·Éî·Éú·É¢·Éò)
          </legend>
          <p className={styles.smallNote}>
            ·Éî·É° ·Éû·Éê·É†·Éê·Éõ·Éî·É¢·É†·Éî·Éë·Éò ·Éí·Éê·Éõ·Éù·Éò·Éß·Éî·Éú·Éî·Éë·Éê ActiveLocations-·É®·Éò (·Éö·Éù·Éô·Éê·É™·Éò·Éî·Éë·Éò·É° ·Éë·Éê·É†·Éê·Éó·Éî·Éë·Éò)
          </p>

          <div className={styles.fileInput}>
            <label>üñºÔ∏è Card Thumbnail (·Éë·Éê·É†·Éê·Éó·Éò·É° ·É°·É£·É†·Éê·Éó·Éò)</label>
            <input
              type="file"
              accept="image/*"
              onChange={(e) => handleCardImage(e.target.files?.[0] || null)}
            />
            {draft.cardImage && (
              <span className={styles.smallNote}>
                ‚úÖ {draft.cardImage.name}
              </span>
            )}
            {draft.cardImageUrl && !draft.cardImage && (
              <span className={styles.smallNote}>
                ·Éê·Éõ·Éü·Éê·Éõ·Éò·Éú·Éì·Éî·Éö·Éò: {draft.cardImageUrl.split("/").pop()}
              </span>
            )}

            {/* Preview */}
            {(draft.cardImage || draft.cardImageUrl) && (
              <div className={styles.imagePreviewWrapper}>
                {/* eslint-disable-next-line @next/next/no-img-element */}
                <img
                  src={
                    draft.cardImage
                      ? URL.createObjectURL(draft.cardImage)
                      : draft.cardImageUrl
                  }
                  alt="Card preview"
                />
              </div>
            )}
          </div>

          <div className={styles.field}>
            <label htmlFor="card-tagline">
              üìù Card Tagline (·Éë·Éê·É†·Éê·Éó·Éò·É° ·Éê·É¶·É¨·Éî·É†·Éê)
            </label>
            <textarea
              id="card-tagline"
              rows={2}
              value={draft.description}
              onChange={(e) => update("description", e.target.value)}
              placeholder="·Éû·Éê·É†·Éê·Éí·Éö·Éê·Éò·Éì·Éò·Éú·Éí·Éò ·Éô·Éê·Éï·Éô·Éê·É°·Éò·Éù·Éú·Éñ·Éî"
            />
            <span className={styles.smallNote}>
              ·É©·Éú·Éì·Éî·Éë·Éê ·Éö·Éù·Éô·Éê·É™·Éò·Éò·É° ·Éë·Éê·É†·Éê·Éó·Éñ·Éî (ActiveLocations)
            </span>
          </div>

          <div className={styles.field}>
            <label>üè∑Ô∏è Tags (·É¢·Éî·Éí·Éî·Éë·Éò)</label>
            <div style={{ display: "flex", gap: ".5rem" }}>
              <input
                value={tagInput}
                onChange={(e) => setTagInput(e.target.value)}
                placeholder="thermal, soaring..."
                onKeyDown={(e) => {
                  if (e.key === "Enter") {
                    e.preventDefault();
                    addTag();
                  }
                }}
              />
              <button
                type="button"
                className={styles.btn}
                onClick={addTag}
                disabled={!tagInput.trim()}
              >
                ·Éì·Éê·Éõ·Éê·É¢·Éî·Éë·Éê
              </button>
            </div>
            {draft.tags.length > 0 && (
              <div className={styles.chips}>
                {draft.tags.map((t) => (
                  <span key={t} className={styles.chip}>
                    {t}
                    <button type="button" onClick={() => removeTag(t)}>
                      √ó
                    </button>
                  </span>
                ))}
              </div>
            )}
          </div>
        </fieldset>

        <div className={styles.actions}>
          <button
            type="button"
            className={`${styles.btn} ${styles.danger}`}
            onClick={backToList}
          >
            ·Éí·Éê·É£·É•·Éõ·Éî·Éë·Éê
          </button>
          <button
            type="submit"
            className={`${styles.btn} ${styles.primary}`}
            disabled={formSaving}
          >
            {formSaving
              ? "·É®·Éî·Éú·Éê·ÉÆ·Éï·Éê..."
              : viewMode === "edit"
              ? "·Éí·Éê·Éú·Éê·ÉÆ·Éö·Éî·Éë·Éê"
              : "·É®·Éî·É•·Éõ·Éú·Éê"}
          </button>
        </div>
        <div className={styles.status}>{formStatus}</div>
      </form>
    </div>
  );
}
